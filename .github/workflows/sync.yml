name: Docker Tools Sync

on:
  schedule:
    # 每小时运行一次 (cron: 0 */1 * * *)
    - cron: '0 */1 * * *'
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'
        
    - name: 安装依赖
      run: |
        pip install requests
        
    - name: 创建data目录
      run: |
        mkdir -p ./data
        
    - name: 运行同步脚本
      run: |
        python sync.py
        
    - name: 删除现有的 Release 和 Tag
      if: success()
      run: |
        # 删除现有的 latest release
        RELEASE_ID=$(gh api repos/:owner/:repo/releases/tags/latest --jq '.id' 2>/dev/null || echo "")
        if [ ! -z "$RELEASE_ID" ]; then
          echo "删除现有的 latest release (ID: $RELEASE_ID)"
          gh api --method DELETE repos/:owner/:repo/releases/$RELEASE_ID
        fi
        
        # 删除现有的 latest tag
        if git rev-parse --verify refs/tags/latest >/dev/null 2>&1; then
          echo "删除现有的 latest tag"
          git tag -d latest
          git push origin :refs/tags/latest
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Release
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        files: |
          data/**
        tag_name: latest
        name: Docker Tools Latest
        body: |
          ## Docker Tools 最新版本
          
          ### 说明:
          自动从官方仓库同步的最新 Docker 相关工具。
          
          **注意**: 这是一个自动更新的 Release，每次发现新版本时会自动替换文件。
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
